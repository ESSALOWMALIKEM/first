import asyncio
import logging
import random
import json
from urllib.parse import quote, unquote
import asyncpg
from aiogram import Bot, Dispatcher, types
from aiogram.client.default import DefaultBotProperties
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, Message
from aiogram import Router, F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError
from keep_alive import keep_alive

keep_alive()

logging.basicConfig(level=logging.INFO)

API_TOKEN = '7790968356:AAGYEPi9cpgovtWmuzV98GYXjRAorWOIsGQ'
SUPER_ADMIN_ID = 7877979174  # L√ºtfen buraya kendi Super Admin ID'nizi girin

DATABASE_URL = "postgresql://htsd_user:NdJwX21r3kuJDcUNZasIGf4M55wHJSXB@dpg-d12im26mcj7s73fd8aug-a/htsd_fxdx"


bot = Bot(token=API_TOKEN, default=DefaultBotProperties(parse_mode="HTML"))
storage = MemoryStorage()
dp = Dispatcher(bot=bot, storage=storage)
router = Router()
dp.include_router(router)

DB_POOL = None

back_to_admin_markup = InlineKeyboardMarkup(inline_keyboard=[
    [InlineKeyboardButton(text="‚¨ÖÔ∏è Admin panele ga√Ωtmak", callback_data="admin_panel_main")]
])

# FSM States
class SubscriptionStates(StatesGroup):
    checking_subscription = State()

class ContactAdmin(StatesGroup):
    waiting_for_message = State()

class AdminStates(StatesGroup):
    waiting_for_channel_id = State()
    waiting_for_channel_name = State()
    waiting_for_multiple_channels = State() # Yeni durum
    waiting_for_channel_to_delete = State()
    waiting_for_vpn_config = State()
    waiting_for_vpn_config_to_delete = State()
    waiting_for_welcome_message = State()
    waiting_for_user_mail_action = State()
    waiting_for_mailing_message = State()
    waiting_for_mailing_confirmation = State()
    waiting_for_mailing_buttons = State()
    waiting_for_channel_mail_action = State()
    waiting_for_channel_mailing_message = State()
    waiting_for_channel_mailing_confirmation = State()
    waiting_for_channel_mailing_buttons = State()
    waiting_for_admin_id_to_add = State()
    waiting_for_addlist_url = State()
    waiting_for_addlist_name = State()


# --- VERƒ∞TABANI FONKSƒ∞YONLARI ---
async def init_db(pool):
    async with pool.acquire() as connection:
        # Mevcut tablolar...
        await connection.execute("""
            CREATE TABLE IF NOT EXISTS bot_settings (key TEXT PRIMARY KEY, value TEXT);
        """)
        await connection.execute("""
            CREATE TABLE IF NOT EXISTS channels (id SERIAL PRIMARY KEY, channel_id TEXT UNIQUE NOT NULL, name TEXT NOT NULL);
        """)
        await connection.execute("""
            CREATE TABLE IF NOT EXISTS addlists (id SERIAL PRIMARY KEY, name TEXT NOT NULL, url TEXT UNIQUE NOT NULL);
        """)
        await connection.execute("""
            CREATE TABLE IF NOT EXISTS vpn_configs (id SERIAL PRIMARY KEY, config_text TEXT UNIQUE NOT NULL);
        """)
        await connection.execute("""
            CREATE TABLE IF NOT EXISTS bot_users (user_id BIGINT PRIMARY KEY);
        """)
        await connection.execute("""
            CREATE TABLE IF NOT EXISTS bot_admins (user_id BIGINT PRIMARY KEY);
        """)
        # Varsayƒ±lan ho≈ü geldin mesajƒ±
        default_welcome = "üëã <b>Ho≈ü geldi≈àiz!</b>\n\nVPN Koduny almak √º√ßin, a≈üakdaky Kanallara Agza bolu≈à we so≈àra Agza boldum d√ºwmesine basy≈à."
        await connection.execute(
            "INSERT INTO bot_settings (key, value) VALUES ($1, $2) ON CONFLICT (key) DO NOTHING",
            'welcome_message', default_welcome
        )

# DB Helper fonksiyonlarƒ± (get_setting, save_setting, vs.) olduƒüu gibi kalƒ±r
async def get_setting_from_db(key: str, default: str = None):
    async with DB_POOL.acquire() as conn:
        row = await conn.fetchrow("SELECT value FROM bot_settings WHERE key = $1", key)
        return row['value'] if row else default

async def save_setting_to_db(key: str, value: str):
    async with DB_POOL.acquire() as conn:
        await conn.execute(
            "INSERT INTO bot_settings (key, value) VALUES ($1, $2) ON CONFLICT (key) DO UPDATE SET value = $2",
            key, value
        )

async def save_last_mail_content(content: dict, keyboard: InlineKeyboardMarkup | None, mail_type: str):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏."""
    content_json = json.dumps(content)
    await save_setting_to_db(f'last_{mail_type}_mail_content', content_json)
    
    if keyboard:
        keyboard_json = json.dumps(keyboard.dict())
        await save_setting_to_db(f'last_{mail_type}_mail_keyboard', keyboard_json)
    else:
        await save_setting_to_db(f'last_{mail_type}_mail_keyboard', 'null')

async def get_last_mail_content(mail_type: str) -> tuple[dict | None, InlineKeyboardMarkup | None]:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏."""
    content = None
    keyboard = None
    
    content_json = await get_setting_from_db(f'last_{mail_type}_mail_content')
    if content_json:
        content = json.loads(content_json)
        
    keyboard_json = await get_setting_from_db(f'last_{mail_type}_mail_keyboard')
    if keyboard_json and keyboard_json != 'null':
        keyboard_data = json.loads(keyboard_json)
        keyboard = InlineKeyboardMarkup.model_validate(keyboard_data)
        
    return content, keyboard

async def send_mail_preview(chat_id: int, content: dict, keyboard: InlineKeyboardMarkup | None = None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç, –º–µ–¥–∏–∞ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç)."""
    content_type = content.get('type')
    caption = content.get('caption')
    text = content.get('text')
    file_id = content.get('file_id')

    if content_type == 'text':
        return await bot.send_message(chat_id, text, reply_markup=keyboard)
    elif content_type == 'photo':
        return await bot.send_photo(chat_id, file_id, caption=caption, reply_markup=keyboard)
    elif content_type == 'video':
        return await bot.send_video(chat_id, file_id, caption=caption, reply_markup=keyboard)
    elif content_type == 'animation':
        return await bot.send_animation(chat_id, file_id, caption=caption, reply_markup=keyboard)
    elif content_type == 'document': # YENƒ∞: Dosya g√∂nderme
        return await bot.send_document(chat_id, file_id, caption=caption, reply_markup=keyboard)


async def get_channels_from_db():
    async with DB_POOL.acquire() as conn:
        rows = await conn.fetch("SELECT channel_id, name FROM channels ORDER BY name")
        return [{"id": row['channel_id'], "name": row['name']} for row in rows]

async def add_channel_to_db(channel_id: str, name: str):
    async with DB_POOL.acquire() as conn:
        try:
            await conn.execute("INSERT INTO channels (channel_id, name) VALUES ($1, $2)", str(channel_id), name)
            return True
        except asyncpg.UniqueViolationError:
            logging.warning(f"Channel {channel_id} already exists.")
            return False
        except Exception as e:
            logging.error(f"Error adding channel {channel_id} to DB: {e}")
            return False

async def delete_channel_from_db(channel_id: str):
    async with DB_POOL.acquire() as conn:
        result = await conn.execute("DELETE FROM channels WHERE channel_id = $1", str(channel_id))
        return result != "DELETE 0"


async def get_addlists_from_db():
    async with DB_POOL.acquire() as conn:
        rows = await conn.fetch("SELECT id, name, url FROM addlists ORDER BY name")
        return [{"db_id": row['id'], "name": row['name'], "url": row['url']} for row in rows]

async def add_addlist_to_db(name: str, url: str):
    async with DB_POOL.acquire() as conn:
        try:
            await conn.execute("INSERT INTO addlists (name, url) VALUES ($1, $2)", name, url)
            return True
        except asyncpg.UniqueViolationError:
            logging.warning(f"Addlist URL {url} already exists.")
            return False
        except Exception as e:
            logging.error(f"Error adding addlist {name} to DB: {e}")
            return False

async def delete_addlist_from_db(db_id: int):
    async with DB_POOL.acquire() as conn:
        result = await conn.execute("DELETE FROM addlists WHERE id = $1", db_id)
        return result != "DELETE 0"

async def get_vpn_configs_from_db():
    async with DB_POOL.acquire() as conn:
        rows = await conn.fetch("SELECT id, config_text FROM vpn_configs ORDER BY id")
        return [{"db_id": row['id'], "config_text": row['config_text']} for row in rows]


async def add_vpn_config_to_db(config_text: str):
    async with DB_POOL.acquire() as conn:
        try:
            await conn.execute("INSERT INTO vpn_configs (config_text) VALUES ($1)", config_text)
            return True
        except asyncpg.UniqueViolationError:
            logging.warning(f"VPN config already exists.")
            return False
        except Exception as e:
            logging.error(f"Error adding VPN config to DB: {e}")
            return False

async def delete_vpn_config_from_db(db_id: int):
    async with DB_POOL.acquire() as conn:
        result = await conn.execute("DELETE FROM vpn_configs WHERE id = $1", db_id)
        return result != "DELETE 0"

async def get_users_from_db():
    async with DB_POOL.acquire() as conn:
        rows = await conn.fetch("SELECT user_id FROM bot_users")
        return [row['user_id'] for row in rows]

async def add_user_to_db(user_id: int):
    async with DB_POOL.acquire() as conn:
        try:
            await conn.execute("INSERT INTO bot_users (user_id) VALUES ($1) ON CONFLICT (user_id) DO NOTHING", user_id)
        except Exception as e:
            logging.error(f"Error adding user {user_id} to DB: {e}")


async def get_admins_from_db():
    async with DB_POOL.acquire() as conn:
        rows = await conn.fetch("SELECT user_id FROM bot_admins")
        admin_list = [row['user_id'] for row in rows]
        if SUPER_ADMIN_ID not in admin_list:
            admin_list.append(SUPER_ADMIN_ID)
        return admin_list


async def add_admin_to_db(user_id: int):
    async with DB_POOL.acquire() as conn:
        try:
            await conn.execute("INSERT INTO bot_admins (user_id) VALUES ($1) ON CONFLICT (user_id) DO NOTHING", user_id)
            return True
        except Exception as e:
            logging.error(f"Error adding admin {user_id} to DB: {e}")
            return False

async def delete_admin_from_db(user_id: int):
    async with DB_POOL.acquire() as conn:
        result = await conn.execute("DELETE FROM bot_admins WHERE user_id = $1", user_id)
        return result != "DELETE 0"

async def is_user_admin_in_db(user_id: int) -> bool:
    if user_id == SUPER_ADMIN_ID:
        return True
    admins = await get_admins_from_db()
    return user_id in admins

# --- YARDIMCI FONKSƒ∞YONLAR ---
async def create_subscription_task_keyboard(user_id: int) -> InlineKeyboardMarkup:
    # Bu fonksiyon olduƒüu gibi kalabilir
    channels = await get_channels_from_db()
    addlists = await get_addlists_from_db()
    keyboard_buttons = []

    for channel in channels:
        try:
            member = await bot.get_chat_member(chat_id=channel['id'], user_id=user_id)
            if member.status not in ['member', 'administrator', 'creator', 'restricted'] or \
               (member.status == 'restricted' and hasattr(member, 'is_member') and not member.is_member):
                keyboard_buttons.append([
                    InlineKeyboardButton(text=f"{channel['name']}", url=f"https://t.me/{str(channel['id']).lstrip('@')}")
                ])
        except Exception as e:
            logging.error(f"Kanala agzalygy barlamakda √Ωal≈ày≈ülyk {channel['id']} ulanyjy {user_id} √º√ßin: {e}")
            keyboard_buttons.append([
                InlineKeyboardButton(text=f"‚ö†Ô∏è {channel['name']} (barlag √Ωal≈ày≈ülygy)", url=f"https://t.me/{str(channel['id']).lstrip('@')}")
            ])
            continue
    for addlist in addlists:
        keyboard_buttons.append([
            InlineKeyboardButton(text=f"{addlist['name']}", url=addlist['url'])
        ])
    if keyboard_buttons:
        keyboard_buttons.append([
            InlineKeyboardButton(text="‚úÖ Agza Boldum", callback_data="check_subscription")
        ])
    return InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)


async def has_unsubscribed_channels(user_id: int) -> bool:
    # Bu fonksiyon olduƒüu gibi kalabilir
    channels = await get_channels_from_db()
    if not channels:
        return False
    for channel in channels:
        try:
            chat_identifier = channel['id']
            if not (isinstance(chat_identifier, str) and chat_identifier.startswith('@')):
                try:
                    chat_identifier = int(str(chat_identifier))
                except ValueError:
                    logging.error(f"get_chat_member √º√ßin n√§dogry kanal ID formaty: {channel['id']}. Ge√ßiril√Ω√§r.")
                    return True
            member = await bot.get_chat_member(chat_id=chat_identifier, user_id=user_id)
            if member.status == 'restricted':
                if hasattr(member, 'is_member') and not member.is_member:
                    logging.info(f"Ulanyjy {user_id} {channel['id']} kanala AGZA BOLMADYK (√Ωagda√Ωy: {member.status}, is_member=False)")
                    return True
            elif member.status not in ['member', 'administrator', 'creator']:
                logging.info(f"Ulanyjy {user_id} {channel['id']} kanala AGZA BOLMADYK (√Ωagda√Ωy: {member.status})")
                return True
        except TelegramForbiddenError:
            logging.error(f"TelegramForbiddenError: Bot {channel['id']} kanaly≈à adminy d√§l. Howpsuzlyk √º√ßin ulanyjy agza bolmadyk hasaplan√Ωar.")
            return True
        except TelegramBadRequest as e:
            logging.warning(f"Ulanyjy {user_id}-i≈à {channel['id']} kanala agzalygy barlanda TelegramBadRequest: {e}. Ulanyjy agza bolmadyk hasaplan√Ωar.")
            return True
        except Exception as e:
            logging.warning(f"Ulanyjy {user_id}-i≈à {channel['id']} kanala agzalygyny barlanda umumy √Ωal≈ày≈ülyk: {e}. Ulanyjy Agza bolmadyk hasaplan√Ωar.")
            return True
    return False

def create_admin_keyboard(user_id: int) -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton(text="üìä Bot statistikasy", callback_data="get_stats")],
        [InlineKeyboardButton(text="üöÄ Ulanyjylara ibermek", callback_data="start_mailing"),
         InlineKeyboardButton(text="üì¢ Kanallara ibermek", callback_data="start_channel_mailing")],
        [InlineKeyboardButton(text="üì° Kanallary Y√∂net", callback_data="manage_channels")], # DEƒûƒ∞≈ûTƒ∞
        [InlineKeyboardButton(text="üìÅ addlist go≈ümak", callback_data="add_addlist"), InlineKeyboardButton(text="üóëÔ∏è addlist pozmak", callback_data="delete_addlist")],
        [InlineKeyboardButton(text="üîë VPN go≈ümak", callback_data="add_vpn_config"), InlineKeyboardButton(text="üóëÔ∏è VPN pozmak", callback_data="delete_vpn_config")],
        [InlineKeyboardButton(text="‚úèÔ∏è Ba≈ülangy√ß haty √º√Ωtgetmek", callback_data="change_welcome")]
    ]
    if user_id == SUPER_ADMIN_ID:
        buttons.extend([
            [InlineKeyboardButton(text="üëÆ Admin go≈ümak", callback_data="add_admin"), InlineKeyboardButton(text="üö´ Admin pozmak", callback_data="delete_admin")]
        ])
    buttons.append([InlineKeyboardButton(text="‚¨ÖÔ∏è Admin panelden √ßykmak", callback_data="exit_admin_panel")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)


# --- KULLANICI-ADMƒ∞N MESAJLA≈ûMA Sƒ∞STEMƒ∞ ---

@router.message(Command("mesaj"))
async def message_admin_start(message: types.Message, state: FSMContext):
    """Kullanƒ±cƒ±nƒ±n adminlere mesaj g√∂nderme s√ºrecini ba≈ülatƒ±r."""
    await state.clear()
    await message.answer(
        "‚úçÔ∏è Adminlere g√∂ndermek isle√Ω√§n habary≈àyzy √Ωazy≈à.\n\n"
        "Habary≈àyz √§hli adminlere iberiler. /start bu√Ωrugyny √Ωazyp, bu √Ωagda√Ωdan √ßykyp bilersi≈àiz.",
        reply_markup=None
    )
    await state.set_state(ContactAdmin.waiting_for_message)

@router.message(ContactAdmin.waiting_for_message)
async def forward_message_to_admins(message: types.Message, state: FSMContext):
    """Kullanƒ±cƒ±nƒ±n mesajƒ±nƒ± t√ºm adminlere iletir."""
    admins = await get_admins_from_db()
    if not admins:
        await message.answer("üòî Gynansak-da, h√§zirki wagtda jogap berjek admin √Ωok.")
        await state.clear()
        return

    # Kullanƒ±cƒ±ya mesajƒ±nƒ±n g√∂nderildiƒüine dair onay ver
    await message.answer("‚úÖ Habary≈àyz adminlere iberildi. Jogap gelmegine gara≈üy≈à.")
    
    # Mesajƒ± t√ºm adminlere ilet
    from_user = message.from_user
    for admin_id in admins:
        try:
            # Mesajƒ± forward et ve admin i√ßin bilgilendirici bir ba≈ülƒ±k ekle
            await bot.forward_message(
                chat_id=admin_id,
                from_chat_id=message.chat.id,
                message_id=message.message_id
            )
            # Ayrƒ± bir metinle kimden geldiƒüini ve nasƒ±l cevap verileceƒüini belirt
            await bot.send_message(
                admin_id,
                f"üë§ <b>T√§ze Habar</b>\n"
                f"<b>Kimden:</b> {from_user.full_name}\n"
                f"<b>User ID:</b> <code>{from_user.id}</code>\n\n"
                f"<i>Bu habara jogap bermek √º√ßin Telegram-y≈à 'Jogap ber' (Reply) a√Ωratynlygyny ulany≈à.</i>"
            )
        except (TelegramForbiddenError, TelegramBadRequest):
            logging.warning(f"Admin {admin_id} ile ileti≈üim kurulamadƒ± veya engellendi.")
        except Exception as e:
            logging.error(f"Admine {admin_id} mesaj iletilirken hata olu≈ütu: {e}")
    
    await state.clear()

async def is_admin_reply(message: Message, bot: Bot):
    """Filtre: Mesajƒ±n bir admin tarafƒ±ndan kullanƒ±cƒ±ya yanƒ±t olup olmadƒ±ƒüƒ±nƒ± kontrol eder."""
    if not message.reply_to_message:
        return False
    # Yanƒ±tlanan mesaj bot tarafƒ±ndan mƒ± g√∂nderilmi≈ü?
    if message.reply_to_message.from_user.id != bot.id:
        return False
    # Yanƒ±tlayan ki≈üi admin mi?
    if not await is_user_admin_in_db(message.from_user.id):
        return False
    # Yanƒ±tlanan mesaj, bir kullanƒ±cƒ±dan gelen ve forward edilen bir mesaj mƒ±?
    # Bunu kontrol etmek i√ßin, botun g√∂nderdiƒüi a√ßƒ±klama metnini arayabiliriz.
    replied_text = message.reply_to_message.text or ""
    if "üë§ T√§ze Habar" in replied_text and "User ID:" in replied_text:
        return True
    return False

@router.message(is_admin_reply)
async def reply_from_admin_to_user(message: types.Message):
    """Adminin yanƒ±tƒ±nƒ± alƒ±r ve ilgili kullanƒ±cƒ±ya g√∂nderir."""
    replied_text = message.reply_to_message.text
    try:
        # User ID'yi metinden √ßƒ±kar
        user_id_str = replied_text.split("User ID:")[1].strip().split("\n")[0]
        user_id = int(user_id_str)
    except (IndexError, ValueError) as e:
        logging.error(f"Yanƒ±tlanan mesajdan user_id √ßƒ±karƒ±lamadƒ±: {e}\nMetin: {replied_text}")
        await message.reply("‚ö†Ô∏è Bu habardan ulanyjy ID-sini almak ba≈üartmady. Ulanyja g√∂n√ºden-g√∂ni jogap beri≈à.")
        return

    try:
        # Adminin mesajƒ±nƒ± kullanƒ±cƒ±ya g√∂nder
        await bot.send_message(
            chat_id=user_id,
            text=f"üì® <b>Admindan Jogap</b> üì®\n\n{message.html_text}"
        )
        # Admine de onayƒ± g√∂nder
        await message.reply("‚úÖ Jogaby≈àyz ulanyja √ºst√ºnlikli iberildi.")
    except (TelegramForbiddenError, TelegramBadRequest):
        await message.reply(f"‚ö†Ô∏è Bu ulanyja (ID: {user_id}) habar ibermek ba≈üartmady. M√ºmkin, ol boty bloklady.")
    except Exception as e:
        await message.reply(f"‚ö†Ô∏è Habar iberilende n√§belli bir √Ωal≈ày≈ülyk √Ω√ºze √ßykdy: {e}")


# --- TEMEL KOMUTLAR (/start, /admin) ---
@router.message(Command("start"))
async def start_command(message: types.Message, state: FSMContext):
    # Bu fonksiyon b√ºy√ºk √∂l√ß√ºde aynƒ± kalabilir
    user_id = message.from_user.id
    await add_user_to_db(user_id)
    await state.clear() # √ñnceki durumlarƒ± temizle

    # ... (geri kalan start mantƒ±ƒüƒ± aynƒ±)
    vpn_configs_full = await get_vpn_configs_from_db()
    vpn_configs = [item['config_text'] for item in vpn_configs_full]

    if not vpn_configs:
        await message.answer("üòî Gynansak-da, h√§zirki wagtda el√Ωeterli VPN Kodlary √Ωok. Ha√Ωy≈ü ed√Ω√§ris, so≈àrak synany≈üy≈à.")
        return

    user_needs_to_subscribe_to_channels = await has_unsubscribed_channels(user_id)
    channels_exist = bool(await get_channels_from_db())

    if not user_needs_to_subscribe_to_channels:
        vpn_config_text = random.choice(vpn_configs)
        text = "üéâ Siz √§hli kanallara Agza boldy≈àyz! " if channels_exist else "‚ú® Agza bolany≈àyz√º√ßin sagbolu≈à!"
        await message.answer(
            f"{text}\n\n"
            f"üîë <b>sizi≈à VPN Kody≈àyz:</b>\n<pre><code>{vpn_config_text}</code></pre>"
        )
    else:
        keyboard = await create_subscription_task_keyboard(user_id)
        welcome_text = await get_setting_from_db('welcome_message', "üëã <b>Ho≈ü geldi≈àiz!</b>\n\nVPN almak √º√ßin, a≈üakdaky Kanallara agza bolu≈à we 'Agza boldum' d√ºwmesine basy≈à.")
        if not keyboard.inline_keyboard:
             if vpn_configs:
                 vpn_config_text = random.choice(vpn_configs)
                 await message.answer(f"‚ú® Agza bolany≈àyz √º√ßin sagbolu≈à!\n\nüîë <b>Sizi≈à VPN Kody≈àyz:</b>\n<pre><code>{vpn_config_text}</code></pre>")
             else:
                 await message.answer("üòî H√§zirki wagtda el√Ωeterli VPN kodlary √Ωok.")
        else:
            await message.answer(welcome_text, reply_markup=keyboard)
            await state.set_state(SubscriptionStates.checking_subscription)


@router.message(Command("admin"))
async def admin_command(message: types.Message, state: FSMContext):
    if not await is_user_admin_in_db(message.from_user.id):
        await message.answer("‚õî Bu bu√Ωruga girm√§ge rugsady≈àyz √Ωok.")
        return
    await message.answer("‚öôÔ∏è <b>Admin-panel</b>\n\nBir hereket sa√Ωla≈à:", reply_markup=create_admin_keyboard(message.from_user.id))
    await state.clear()


# --- ADMIN PANELƒ∞ HANDLERLARI ---

@router.callback_query(lambda c: c.data == "exit_admin_panel")
async def exit_admin_panel_handler(callback: types.CallbackQuery, state: FSMContext):
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    await state.clear()
    try:
        await callback.message.edit_text(
            "‚úÖ Siz admin panelden √ßykdy≈àyz.\n\n"
            "Adaty ulanyjy h√∂km√ºnde t√§zeden i≈üe ba≈ülamak √º√ßin /start girizi≈à. "
            "Adminlere habar ibermek √º√ßin /mesaj girizi≈à.",
            reply_markup=None
        )
    except TelegramBadRequest:
        await callback.message.answer(
             "‚úÖ Siz admin panelden √ßykdy≈àyz.\n\n"
            "Adaty ulanyjy h√∂km√ºnde t√§zeden i≈üe ba≈ülamak √º√ßin /start girizi≈à. "
            "Adminlere habar ibermek √º√ßin /mesaj girizi≈à.",
            reply_markup=None
        )
    await callback.answer()

@router.callback_query(lambda c: c.data == "get_stats")
async def get_statistics(callback: types.CallbackQuery):
    # Bu fonksiyon olduƒüu gibi kalabilir
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    
    async with DB_POOL.acquire() as conn:
        user_count = await conn.fetchval("SELECT COUNT(*) FROM bot_users")
        channel_count = await conn.fetchval("SELECT COUNT(*) FROM channels")
        addlist_count = await conn.fetchval("SELECT COUNT(*) FROM addlists")
        vpn_count = await conn.fetchval("SELECT COUNT(*) FROM vpn_configs")
        # Super admini saymadan diƒüer adminleri say
        admin_count = await conn.fetchval("SELECT COUNT(*) FROM bot_admins")

    status_description = "Bot i≈üle√Ω√§r" if vpn_count > 0 else "VPN KODLARY √ùOK!"
    alert_text = (
        f"üìä Bot statistikasy:\n"
        f"üë§ Ulanyjylar: {user_count}\n"
        f"üì¢ Kanallar: {channel_count}\n"
        f"üìÅ addlistlar: {addlist_count}\n"
        f"üîë VPN Kodlary: {vpn_count}\n"
        f"üëÆ Adminler (go≈üm.): {admin_count}\n"
        f"‚öôÔ∏è √ùagda√Ωy: {status_description}"
    )
    try:
        await callback.answer(text=alert_text, show_alert=True)
    except Exception as e:
        logging.error(f"Statistikany du√Ωdury≈üda g√∂rkezmekde √Ωal≈ày≈ülyk: {e}")
        await callback.answer("‚ö†Ô∏è Statistika g√∂rkezmekde √Ωal≈ày≈ülyk.", show_alert=True)


# --- KANAL Y√ñNETƒ∞Mƒ∞ (YENƒ∞ Sƒ∞STEM) ---

@router.callback_query(lambda c: c.data == "manage_channels")
async def manage_channels_prompt(callback: types.CallbackQuery):
    """Admin'e tekli veya √ßoklu kanal ekleme se√ßeneƒüi sunar."""
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ûï Tek Kanal Ekle", callback_data="add_single_channel")],
        [InlineKeyboardButton(text="‚ûï‚ûï Toplu Kanal Ekle", callback_data="add_multiple_channels")],
        [InlineKeyboardButton(text="‚ûñ Kanal Poz", callback_data="delete_channel")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è Admin panele ga√Ωtmak", callback_data="admin_panel_main")]
    ])
    
    await callback.message.edit_text(
        "üì° <b>Kanallary Dolandyrmak</b> üì°\n\n"
        "A≈üakdaky amallardan birini sa√Ωla≈à:",
        reply_markup=keyboard
    )
    await callback.answer()

@router.callback_query(lambda c: c.data == "add_single_channel")
async def process_add_channel_prompt(callback: types.CallbackQuery, state: FSMContext):
    """Tekli kanal ekleme s√ºrecini ba≈ülatƒ±r."""
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    await callback.message.edit_text(
        "üì° <b>Tek Kanal Go≈ümak</b> üì°\n\n"
        "Kanaly≈à ID-sini girizi≈à (meselem, <code>@PublicChannel</code>) √Ωa-da ≈üahsy kanaly≈à ID-sini (meselem, <code>-1001234567890</code>).\n\n"
        "<i>Bot, agzalar barada maglumat almak hukugy bilen kanala administrator h√∂km√ºnde go≈üulmaly.</i>\n",
        reply_markup=back_to_admin_markup
    )
    await state.update_data(admin_message_id=callback.message.message_id, admin_chat_id=callback.message.chat.id)
    await state.set_state(AdminStates.waiting_for_channel_id)
    await callback.answer()

@router.callback_query(lambda c: c.data == "add_multiple_channels")
async def process_add_multiple_channels_prompt(callback: types.CallbackQuery, state: FSMContext):
    """√áoklu kanal ekleme s√ºrecini ba≈ülatƒ±r."""
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    await callback.message.edit_text(
        "üì° <b>Toplu Kanal Go≈ümak</b> üì°\n\n"
        "Go≈ümak isle√Ω√§n kanallary≈àyzy her setire bir kanal gelecek ≈üekilde a≈üakdaky formatda girizi≈à:\n\n"
        "<code>Kanal_ID,G√∂r√ºncek Ady</code>\n\n"
        "<b>Meselem:</b>\n"
        "<code>@my_channel,Meni≈à Kanalym</code>\n"
        "<code>-10012345678,Meni≈à Hususy Kanalym</code>\n\n"
        "<i>Her kanal √º√ßin bot administrator bolmaly.</i>",
        reply_markup=back_to_admin_markup
    )
    await state.set_state(AdminStates.waiting_for_multiple_channels)
    await callback.answer()


@router.message(AdminStates.waiting_for_multiple_channels)
async def process_multiple_channels(message: types.Message, state: FSMContext):
    """√áoklu kanal girdisini i≈üler ve veritabanƒ±na ekler."""
    if not await is_user_admin_in_db(message.from_user.id): return
    
    lines = message.text.strip().split('\n')
    added_count = 0
    failed_channels = []

    status_message = await message.answer("‚è≥ Kanallar barlan√Ωar we go≈üul√Ωar, gara≈üy≈à...")

    for line in lines:
        try:
            channel_id, channel_name = map(str.strip, line.split(',', 1))
        except ValueError:
            failed_channels.append(f"<code>{line}</code> (N√§dogry format)")
            continue

        # ID format kontrol√º
        if not (channel_id.startswith('@') or (channel_id.startswith('-100') and channel_id[1:].isdigit())):
            failed_channels.append(f"<code>{channel_id}</code> (N√§dogry ID formaty)")
            continue
        
        # Bot admin mi kontrol√º
        try:
            bot_member = await bot.get_chat_member(chat_id=channel_id, user_id=bot.id)
            if bot_member.status not in ['administrator', 'creator']:
                failed_channels.append(f"<code>{channel_id}</code> (Bot admin d√§l)")
                continue
        except Exception:
            failed_channels.append(f"<code>{channel_id}</code> (Kanal tapylmady √Ωa-da barlamak ba≈üartmady)")
            continue
        
        # Veritabanƒ±na ekleme
        success = await add_channel_to_db(channel_id, channel_name)
        if success:
            added_count += 1
        else:
            failed_channels.append(f"<code>{channel_id}</code> (E√Ω√Ω√§m bar √Ωa-da DB √Ωal≈ày≈ülygy)")

    report_text = f"‚úÖ <b>Toplu Kanal Go≈ümak Tamamlandy</b>\n\n" \
                  f"üëç √úst√ºnlikli Go≈üulan: <b>{added_count}</b>\n" \
                  f"üëé Ba≈üarƒ±syz Bolan: <b>{len(failed_channels)}</b>"
    
    if failed_channels:
        report_text += "\n\n<b>Ba≈üarƒ±syz bolan kanallar:</b>\n" + "\n".join(failed_channels)

    await status_message.edit_text(report_text, reply_markup=back_to_admin_markup)
    await state.clear()


# --- DUYURU (MAILING) Sƒ∞STEMƒ∞ (DOSYA DESTEƒûƒ∞ EKLENDƒ∞) ---
def parse_buttons_from_text(text: str) -> types.InlineKeyboardMarkup | None:
    # Bu fonksiyon olduƒüu gibi kalabilir
    lines = text.strip().split('\n')
    keyboard_buttons = []
    for line in lines:
        if ' - ' not in line:
            continue
        parts = line.split(' - ', 1)
        btn_text = parts[0].strip()
        btn_url = parts[1].strip()
        if btn_text and (btn_url.startswith('https://') or btn_url.startswith('http://')):
            keyboard_buttons.append([types.InlineKeyboardButton(text=btn_text, url=btn_url)])
    if not keyboard_buttons:
        return None
    return types.InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)

async def process_mailing_content(message: Message, state: FSMContext, mail_type: str):
    """
    Duyuru i√ßin i√ßeriƒüi i≈üleyen evrensel fonksiyon.
    Metin, fotoƒüraf, video, GIF ve DOK√úMAN kabul eder.
    """
    content = {}
    if message.photo:
        content = {'type': 'photo', 'file_id': message.photo[-1].file_id, 'caption': message.caption}
    elif message.video:
        content = {'type': 'video', 'file_id': message.video.file_id, 'caption': message.caption}
    elif message.animation:
        content = {'type': 'animation', 'file_id': message.animation.file_id, 'caption': message.caption}
    elif message.document: # YENƒ∞: Dosya i√ßeriƒüi
        content = {'type': 'document', 'file_id': message.document.file_id, 'caption': message.caption}
    elif message.text:
        content = {'type': 'text', 'text': message.html_text}
    else:
        await message.answer("‚ö†Ô∏è Bu habar g√∂rn√º≈üi goldanma√Ωar. Tekst, surat, wideo, GIF √Ωa-da DOKUMENT iberi≈à.")
        return

    await state.update_data(mailing_content=content)
    
    fsm_data = await state.get_data()
    admin_message_id = fsm_data.get('admin_message_id')
    admin_chat_id = message.chat.id

    try:
        await bot.delete_message(admin_chat_id, admin_message_id)
    except (TelegramBadRequest, AttributeError):
        pass

    preview_text = "üóÇÔ∏è <b>√ñ≈à√ºnden tassykla≈à:</b>\n\nHabary≈àyz a≈üakdaky √Ωaly bolar. Iber√Ω√§rismi?"
    preview_message = await send_mail_preview(admin_chat_id, content)

    confirmation_keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üöÄ D√ºwmesiz ibermek", callback_data=f"{mail_type}_mail_confirm_send")],
        [InlineKeyboardButton(text="‚ûï D√ºwmeleri go≈ümak", callback_data=f"{mail_type}_mail_confirm_add_buttons")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è √ùatyr", callback_data="admin_panel_main")]
    ])
    confirm_msg = await bot.send_message(admin_chat_id, preview_text, reply_markup=confirmation_keyboard)

    await state.update_data(admin_message_id=confirm_msg.message_id, preview_message_id=preview_message.message_id)

    if mail_type == "user":
        await state.set_state(AdminStates.waiting_for_mailing_confirmation)
    else:
        await state.set_state(AdminStates.waiting_for_channel_mailing_confirmation)

@router.message(AdminStates.waiting_for_mailing_message, F.content_type.in_({'text', 'photo', 'video', 'animation', 'document'})) # DEƒûƒ∞≈ûTƒ∞
async def process_user_mailing_message(message: Message, state: FSMContext):
    if not await is_user_admin_in_db(message.from_user.id): return
    await process_mailing_content(message, state, "user")

@router.message(AdminStates.waiting_for_channel_mailing_message, F.content_type.in_({'text', 'photo', 'video', 'animation', 'document'})) # DEƒûƒ∞≈ûTƒ∞
async def process_channel_mailing_message(message: Message, state: FSMContext):
    if not await is_user_admin_in_db(message.from_user.id): return
    await process_mailing_content(message, state, "channel")

# Geri kalan kod (eski kanal ekleme mantƒ±ƒüƒ± hari√ß) b√ºy√ºk √∂l√ß√ºde aynƒ± kalabilir.
# ...
# Bu noktadan sonra, orijinal dosyanƒ±zdaki
# process_channel_id'den ba≈ülayarak save_channel'a kadar olan
# tekli kanal ekleme fonksiyonlarƒ±,
# duyuru (mailing) fonksiyonlarƒ± (execute_user_broadcast, start_mailing_prompt, vb.),
# addlist y√∂netimi (process_add_addlist_prompt, vb.),
# VPN y√∂netimi (process_add_vpn_config_prompt, vb.),
# admin ekleme/silme (add_admin_prompt, vb.)
# ve ana `main` d√∂ng√ºs√º gibi geri kalan t√ºm fonksiyonlarƒ±
# buraya kopyalayabilirsiniz. Onlarda istenen bir deƒüi≈üiklik bulunmamaktadƒ±r.
# Sadece yukarƒ±daki deƒüi≈üiklikleri entegre etmek yeterlidir.
# Okunabilirlik i√ßin, geri kalan fonksiyonlarƒ± a≈üaƒüƒ±ya ekliyorum.


@router.message(AdminStates.waiting_for_channel_id)
async def process_channel_id(message: types.Message, state: FSMContext):
    if not await is_user_admin_in_db(message.from_user.id): return
    channel_id_input = message.text.strip()
    try:
        await message.delete()
    except TelegramBadRequest:
        pass

    fsm_data = await state.get_data()
    admin_message_id = fsm_data.get('admin_message_id')
    admin_chat_id = fsm_data.get('admin_chat_id')
    original_prompt_id = (
        "üì° <b>Kanal Go≈ümak: ID</b> üì°\n\n"
        "Kanaly≈à ID-sini girizi≈à (<code>@PublicChannel</code> √Ωa-da <code>-100...</code>).\n"
        "<i>Bot kanalda administrator bolmaly.</i>"
    )
    cancel_button_row = [InlineKeyboardButton(text="‚¨ÖÔ∏è Admin panele ga√Ωtmak", callback_data="admin_panel_main")]

    if not admin_message_id or not admin_chat_id:
        await bot.send_message(message.chat.id, "‚ö†Ô∏è √ùagda√Ω √Ωal≈ày≈ülygy. Admin panelden t√§zeden synany≈üy≈à.", reply_markup=create_admin_keyboard(message.from_user.id))
        await state.clear()
        return

    if not (channel_id_input.startswith('@') or (channel_id_input.startswith('-100') and channel_id_input[1:].replace('-', '', 1).isdigit())):
        await bot.edit_message_text(
            f"‚ö†Ô∏è <b>√ùal≈ày≈ülyk:</b> N√§dogry kanal ID formaty.\n\n{original_prompt_id}",
            chat_id=admin_chat_id, message_id=admin_message_id,
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[cancel_button_row])
        )
        return

    channels_in_db = await get_channels_from_db()
    if any(str(ch['id']) == str(channel_id_input) for ch in channels_in_db):
        await bot.edit_message_text(f"‚ö†Ô∏è Bu kanal (<code>{channel_id_input}</code>) e√Ω√Ω√§m sanawda bar.\n\n{original_prompt_id}", chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=InlineKeyboardMarkup(inline_keyboard=[cancel_button_row]))
        return

    try:
        chat_to_check_str = channel_id_input
        chat_to_check = int(chat_to_check_str) if not chat_to_check_str.startswith('@') else chat_to_check_str
        
        bot_member = await bot.get_chat_member(chat_id=chat_to_check, user_id=bot.id)
        if bot_member.status not in ['administrator', 'creator']:
            await bot.edit_message_text(
                "‚ö†Ô∏è <b>√ùal≈ày≈ülyk:</b> Bot bu kanaly≈à administratory d√§l (√Ωa-da gatna≈üyjylar barada maglumat almak hukugy √Ωok).\n"
                "Ha√Ωy≈ü ed√Ω√§ris, boty kanala zerur hukuklar bilen administrator h√∂km√ºnde go≈üu≈à we t√§zeden synany≈üy≈à.",
                chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=back_to_admin_markup
            )
            await state.clear()
            return
    except ValueError:
        await bot.edit_message_text(
            f"‚ö†Ô∏è <b>√ùal≈ày≈ülyk:</b> ≈ûahsy kanaly≈à ID-si san bolmaly (meselem, <code>-1001234567890</code>).\n\n{original_prompt_id}",
            chat_id=admin_chat_id, message_id=admin_message_id,
            reply_markup=InlineKeyboardMarkup(inline_keyboard=[cancel_button_row])
        )
        return
    except TelegramBadRequest as e:
        logging.error(f"TelegramBadRequest –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª–µ {channel_id_input}: {e}")
        error_detail = str(e)
        specific_guidance = ""
        if "member list is inaccessible" in error_detail.lower():
            specific_guidance = ("<b>Maslahat:</b> Botu≈à '√áaty dolandyryp bilmek' √Ωa-da ≈ü.m., gatna≈üyjylary≈à sanawyny almaga m√ºmkin√ßilik ber√Ω√§n hukugyny≈à bardygyna g√∂z √Ωetiri≈à. K√§bir √Ωagda√Ωlarda, eger kanal √ßat bilen baglany≈üykly bolsa, hukuklar miras alnyp bilner.")
        elif "chat not found" in error_detail.lower():
            specific_guidance = "<b>Maslahat:</b> Kanal ID-sini≈à dogry girizilendigine we kanaly≈à bardygyna g√∂z √Ωetiri≈à. Jemgy√Ωet√ßilik kanallary √º√ßin @username, ≈üahsy kanallar √º√ßin bolsa sanly ID ( -100 bilen ba≈üla√Ωan) ulany≈à."
        elif "bot is not a member of the channel" in error_detail.lower() or "user not found" in error_detail.lower():
             specific_guidance = "<b>Maslahat:</b> Bot g√∂rkezilen kanaly≈à agzasy d√§l. Ha√Ωy≈ü ed√Ω√§ris, ilki boty kanala go≈üu≈à."
        await bot.edit_message_text(
            f"‚ö†Ô∏è <b>Boty≈à kanaldaky √Ωagda√Ωyny barlamakda √Ωal≈ày≈ülyk:</b>\n<code>{error_detail}</code>\n\n"
            f"{specific_guidance}\n\n"
            "ID-ni≈à dogrudygyny, boty≈à kanala go≈üulandygyny we zerur administrator hukuklaryny≈à bardygyny barla≈à.",
            chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=back_to_admin_markup
        )
        await state.clear()
        return
    except Exception as e:
        logging.error(f"√Ωal≈ày≈ülyk {channel_id_input}: {e}")
        await bot.edit_message_text(
            f"‚ö†Ô∏è <b>Boty≈à kanaldaky √Ωagda√Ωyny barlamakda gara≈üylmadyk √Ωal≈ày≈ülyk:</b> <code>{e}</code>.\n"
            "ID-ni≈à dogrudygyny, boty≈à kanala go≈üulandygyny we administrator hukuklaryny≈à bardygyny barla≈à.",
            chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=back_to_admin_markup
        )
        await state.clear()
        return

    await state.update_data(channel_id=channel_id_input)
    await bot.edit_message_text(
        "‚úèÔ∏è Indi bu kanal √º√ßin <b>g√∂rkezil√Ω√§n ady</b> girizi≈à (meselem, <i>TKM VPNLAR</i>):",
        chat_id=admin_chat_id, message_id=admin_message_id,
        reply_markup=InlineKeyboardMarkup(inline_keyboard=[[cancel_button_row]])
    )
    await state.set_state(AdminStates.waiting_for_channel_name)


@router.message(AdminStates.waiting_for_channel_name)
async def save_channel(message: types.Message, state: FSMContext):
    if not await is_user_admin_in_db(message.from_user.id): return
    channel_name = message.text.strip()
    try:
        await message.delete()
    except TelegramBadRequest:
        pass

    fsm_data = await state.get_data()
    admin_message_id = fsm_data.get('admin_message_id')
    admin_chat_id = fsm_data.get('admin_chat_id')
    channel_id_str = fsm_data.get('channel_id')
    original_prompt_name = "‚úèÔ∏è Kanal √º√ßin <b>g√∂rkezil√Ω√§n ady</b> girizi≈à (meselem, <i>Tehnologi√Ωa Habarlary</i>):"
    cancel_button_row = [InlineKeyboardButton(text="‚¨ÖÔ∏è Admin panele ga√Ωtmak", callback_data="admin_panel_main")]

    if not all([admin_message_id, admin_chat_id, channel_id_str]):
        err_msg_text = "‚ö†Ô∏è √ùagda√Ω √Ωal≈ày≈ülygy (zerur maglumatlar √Ωok). Kanaly t√§zeden go≈ümagy synany≈üy≈à."
        if admin_message_id and admin_chat_id:
            try:
                await bot.edit_message_text(err_msg_text, chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=back_to_admin_markup)
            except TelegramBadRequest:
                 await bot.send_message(admin_chat_id, err_msg_text, reply_markup=back_to_admin_markup)
        else:
            await bot.send_message(message.chat.id, err_msg_text, reply_markup=create_admin_keyboard(message.from_user.id))
        await state.clear()
        return

    if not channel_name:
        await bot.edit_message_text(f"‚ö†Ô∏è Kanal ady bo≈ü bolup bilmez.\n\n{original_prompt_name}", chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=InlineKeyboardMarkup(inline_keyboard=[[cancel_button_row]]))
        return

    success = await add_channel_to_db(channel_id_str, channel_name)
    if success:
        await bot.edit_message_text(f"‚úÖ <b>{channel_name}</b> kanaly (<code>{channel_id_str}</code>) √ºst√ºnlikli go≈üuldy!", chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=back_to_admin_markup)
    else:
        await bot.edit_message_text(f"‚ö†Ô∏è <b>{channel_name}</b> kanalyny (<code>{channel_id_str}</code>) go≈ümak ba≈üartmady. M√ºmkin, ol e√Ω√Ω√§m bar √Ωa-da maglumatlar bazasynda √Ωal≈ày≈ülyk boldy.", chat_id=admin_chat_id, message_id=admin_message_id, reply_markup=back_to_admin_markup)
    await state.clear()

@router.callback_query(lambda c: c.data == "delete_channel")
async def process_delete_channel_prompt(callback: types.CallbackQuery, state: FSMContext):
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    
    channels = await get_channels_from_db()

    if not channels:
        await callback.message.edit_text("üóëÔ∏è Kanallary≈à sanawy bo≈ü. Pozmak √º√ßin hi√ß zat √Ωok.", reply_markup=back_to_admin_markup)
        await callback.answer()
        return

    keyboard_buttons = [
        [InlineKeyboardButton(text=f"{channel['name']} ({channel['id']})", callback_data=f"del_channel:{channel['id']}")] for channel in channels
    ]
    keyboard_buttons.append([InlineKeyboardButton(text="‚¨ÖÔ∏è Admin men√Ωusyna ga√Ωt", callback_data="admin_panel_main")])

    await callback.message.edit_text("üî™ <b>Kanal Pozmak</b> üî™\n\nSanawdan pozmak √º√ßin kanaly sa√Ωla≈à:", reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard_buttons))
    await callback.answer()

@router.callback_query(lambda c: c.data.startswith("del_channel:"))
async def confirm_delete_channel(callback: types.CallbackQuery, state: FSMContext):
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    channel_id_to_delete_str = callback.data.split(":", 1)[1]

    deleted = await delete_channel_from_db(channel_id_to_delete_str)

    if deleted:
        await callback.message.edit_text(f"üóëÔ∏è Kanal (<code>{channel_id_to_delete_str}</code>) √ºst√ºnlikli pozuldy.", reply_markup=back_to_admin_markup)
        await callback.answer("Kanal pozuldy", show_alert=False)
    else:
        await callback.message.edit_text("‚ö†Ô∏è Kanal tapylmady √Ωa-da pozmakda √Ωal≈ày≈ülyk √Ω√ºze √ßykdy.", reply_markup=back_to_admin_markup)
        await callback.answer("Kanal tapylmady √Ωa-da √Ωal≈ày≈ülyk", show_alert=True)

@router.callback_query(lambda c: c.data == "admin_panel_main")
async def back_to_admin_panel(callback: types.CallbackQuery, state: FSMContext):
    if not await is_user_admin_in_db(callback.from_user.id):
        await callback.answer("‚õî Giri≈ü gadagan.", show_alert=True)
        return
    
    admin_reply_markup = create_admin_keyboard(callback.from_user.id)
    try:
        await callback.message.edit_text(
            "‚öôÔ∏è <b>Admin-panel</b>\n\nBir hereket sa√Ωla≈à:",
            reply_markup=admin_reply_markup
        )
    except TelegramBadRequest:
        await callback.message.answer(
             "‚öôÔ∏è <b>Admin-panel</b>\n\nBir hereket sa√Ωla≈à:",
            reply_markup=admin_reply_markup
        )
        try:
            await callback.message.delete()
        except TelegramBadRequest:
            pass
    await state.clear()
    await callback.answer()

# ... (Kalan t√ºm fonksiyonlar: addlist, vpn, welcome message, admin management, mailing logic, subscription check, etc.)
# ... Orijinal dosyanƒ±zdaki bu fonksiyonlarƒ± buraya yapƒ±≈ütƒ±rabilirsiniz.
# ... Deƒüi≈üiklik gerektiren t√ºm kƒ±sƒ±mlar yukarƒ±da g√ºncellenmi≈ütir.
async def execute_user_broadcast(admin_message: types.Message, mailing_content: dict, mailing_keyboard: types.InlineKeyboardMarkup | None):
    users_to_mail = await get_users_from_db()
    
    if not users_to_mail:
        await admin_message.edit_text("üë• Ibermek √º√ßin ulanyjylar √Ωok.", reply_markup=back_to_admin_markup)
        return

    await admin_message.edit_text(f"‚è≥ <b>{len(users_to_mail)}</b> sany ulanyja ibermek ba≈ülan√Ωar...", reply_markup=None)

    success_count = 0
    fail_count = 0
    for user_id in users_to_mail:
        try:
            await send_mail_preview(user_id, mailing_content, mailing_keyboard)
            success_count += 1
        except (TelegramForbiddenError, TelegramBadRequest):
            fail_count += 1
        except Exception as e:
            fail_count += 1
            logging.error(f"Ulanyja {user_id} iberlende n√§belli √Ωal≈ày≈ülyk: {e}")
        await asyncio.sleep(0.1)

    await save_last_mail_content(mailing_content, mailing_keyboard, "user")

    final_report_text = f"‚úÖ <b>Ulanyjylara Iberi≈ü Tamamlandy</b> ‚úÖ\n\nüëç √úst√ºnlikli: {success_count}\nüëé Ba≈üartmady: {fail_count}"
    await admin_message.edit_text(final_report_text, reply_markup=back_to_admin_markup)


@router.callback_query(lambda c: c.data == "start_mailing")
async def start_mailing_prompt(callback: types.CallbackQuery, state: FSMContext):
    if not await is_user_admin_in_db(callback.from_user.id): return
    
    last_content, _ = await get_last_mail_content("user")
    
    keyboard_buttons = [[InlineKeyboardButton(text="‚ûï T√§ze habar d√∂retmek", callback_data="create_new_user_mail")]]
    if last_content:
        keyboard_buttons.insert(0, [InlineKeyboardButton(text="üîÑ So≈àky habary ulanmak", callback_data="repeat_last_user_mail")])
    
    keyboard_buttons.append([InlineKeyboardButton(text="‚¨ÖÔ∏è Yza", callback_data="admin_panel_main")])
    
    await callback.message.edit_text(
        "üì¨ <b>Ulanyjylara Iberi≈ü</b> üì¨\n\nBir hereket sa√Ωla≈à:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
    )
    await state.set_state(AdminStates.waiting_for_user_mail_action)
    await callback.answer()


@router.callback_query(AdminStates.waiting_for_user_mail_action)
async def process_user_mail_action(callback: types.CallbackQuery, state: FSMContext):
    action = callback.data
    if action == "create_new_user_mail":
        await callback.message.edit_text(
            "‚úçÔ∏è Ibermek isle√Ω√§n habary≈àyzy (tekst, surat, wideo, GIF √Ωa-da dokument) iberi≈à.",
            reply_markup=back_to_admin_markup
        )
        await state.update_data(admin_message_id=callback.message.message_id)
        await state.set_state(AdminStates.waiting_for_mailing_message)
    elif action == "repeat_last_user_mail":
        content, keyboard = await get_last_mail_content("user")
        if not content:
            await callback.answer("‚ö†Ô∏è So≈àky habar tapylmady.", show_alert=True)
            return

        await state.update_data(mailing_content=content, mailing_keyboard=keyboard)
        await callback.message.delete()
        
        preview_text = "üóÇÔ∏è <b>So≈àky habary tassykla≈à:</b>\n\n≈ûu habary ulanyjylara iber√Ω√§rismi?"
        preview_msg = await send_mail_preview(callback.from_user.id, content, keyboard)
        
        confirmation_keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ Hawa, ibermek", callback_data="user_mail_confirm_send_repeated")],
            [InlineKeyboardButton(text="‚¨ÖÔ∏è √ùok, yza", callback_data="admin_panel_main")]
        ])
        confirm_msg = await bot.send_message(callback.from_user.id, preview_text, reply_markup=confirmation_keyboard)

        await state.update_data(admin_message_id=confirm_msg.message_id, preview_message_id=preview_msg.message_id)
        await state.set_state(AdminStates.waiting_for_mailing_confirmation)
    await callback.answer()


@router.callback_query(AdminStates.waiting_for_mailing_confirmation)
async def process_user_mailing_confirmation(callback: types.CallbackQuery, state: FSMContext):
    fsm_data = await state.get_data()
    mailing_content = fsm_data.get('mailing_content')
    mailing_keyboard = fsm_data.get('mailing_keyboard')
    
    try:
        await bot.delete_message(callback.from_user.id, fsm_data.get('admin_message_id'))
        await bot.delete_message(callback.from_user.id, fsm_data.get('preview_message_id'))
    except (TelegramBadRequest, KeyError): pass

    if not mailing_content:
        await bot.send_message(callback.from_user.id, "‚ö†Ô∏è √ùal≈ày≈ülyk: habar tapylmady.", reply_markup=back_to_admin_markup)
        await state.clear()
        return

    if callback.data in ["user_mail_confirm_send", "user_mail_confirm_send_repeated"]:
        msg_for_broadcast = await bot.send_message(callback.from_user.id, "‚è≥...")
        await execute_user_broadcast(msg_for_broadcast, mailing_content, mailing_keyboard)
        await state.clear()
    elif callback.data == "user_mail_confirm_add_buttons":
        msg = await bot.send_message(
            callback.from_user.id,
            "üîó <b>D√ºwmeleri go≈ümak</b> üîó\n\nFormat: <code>Tekst - https://salgy.com</code>\nHer d√ºwme t√§ze setirde.",
            reply_markup=back_to_admin_markup
        )
        await state.update_data(admin_message_id=msg.message_id)
        await state.set_state(AdminStates.waiting_for_mailing_buttons)
    await callback.answer()


@router.message(AdminStates.waiting_for_mailing_buttons)
async def process_user_mailing_buttons(message: Message, state: FSMContext):
    keyboard = parse_buttons_from_text(message.text)
    if not keyboard:
        await message.answer("‚ö†Ô∏è N√§dogry format! T√§zeden synany≈üy≈à.")
        return
    
    await message.delete()
    fsm_data = await state.get_data()
    mailing_content = fsm_data.get('mailing_content')
    
    try: await bot.delete_message(message.chat.id, fsm_data.get('admin_message_id'))
    except (TelegramBadRequest, KeyError): pass

    msg_for_broadcast = await bot.send_message(message.chat.id, "‚è≥...")
    await execute_user_broadcast(msg_for_broadcast, mailing_content, keyboard)
    await state.clear()


async def execute_channel_broadcast(admin_message: types.Message, mailing_content: dict, mailing_keyboard: types.InlineKeyboardMarkup | None):
    channels_to_mail = await get_channels_from_db()
    if not channels_to_mail:
        await admin_message.edit_text("üì¢ Ibermek √º√ßin kanallar √Ωok.", reply_markup=back_to_admin_markup)
        return

    await admin_message.edit_text(f"‚è≥ <b>{len(channels_to_mail)}</b> sany kanala ibermek ba≈ülan√Ωar...", reply_markup=None)

    success_count = 0
    fail_count = 0
    for channel in channels_to_mail:
        try:
            await send_mail_preview(channel['id'], mailing_content, mailing_keyboard)
            success_count += 1
        except (TelegramForbiddenError, TelegramBadRequest) as e:
            fail_count += 1
            logging.warning(f"Kanala {channel['name']} ({channel['id']}) habar ibermek ba≈üartmady: {e}")
        except Exception as e:
            fail_count += 1
            logging.error(f"Kanala {channel['name']} ({channel['id']}) iberlende n√§belli √Ωal≈ày≈ülyk: {e}")
        await asyncio.sleep(0.2)
    
    await save_last_mail_content(mailing_content, mailing_keyboard, "channel")

    final_report_text = f"‚úÖ <b>Kanallara Iberi≈ü Tamamlandy</b> ‚úÖ\n\nüëç √úst√ºnlikli: {success_count}\nüëé Ba≈üartmady: {fail_count}"
    await admin_message.edit_text(final_report_text, reply_markup=back_to_admin_markup)

@router.callback_query(lambda c: c.data == "start_channel_mailing")
async def start_channel_mailing_prompt(callback: types.CallbackQuery, state: FSMContext):
    if not await is_user_admin_in_db(callback.from_user.id): return
    
    last_content, _ = await get_last_mail_content("channel")
    
    keyboard_buttons = [[InlineKeyboardButton(text="‚ûï T√§ze habar d√∂retmek", callback_data="create_new_channel_mail")]]
    if last_content:
        keyboard_buttons.insert(0, [InlineKeyboardButton(text="üîÑ So≈àky habary ulanmak", callback_data="repeat_last_channel_mail")])
    
    keyboard_buttons.append([InlineKeyboardButton(text="‚¨ÖÔ∏è Yza", callback_data="admin_panel_main")])

    await callback.message.edit_text(
        "üì¢ <b>Kanallara Iberi≈ü</b> üì¢\n\nBir hereket sa√Ωla≈à:",
        reply_markup=InlineKeyboardMarkup(inline_keyboard=keyboard_buttons)
    )
    await state.set_state(AdminStates.waiting_for_channel_mail_action)
    await callback.answer()


@router.callback_query(AdminStates.waiting_for_channel_mail_action)
async def process_channel_mail_action(callback: types.CallbackQuery, state: FSMContext):
    action = callback.data
    if action == "create_new_channel_mail":
        await callback.message.edit_text(
            "‚úçÔ∏è Ibermek isle√Ω√§n habary≈àyzy (tekst, surat, wideo, GIF √Ωa-da dokument) iberi≈à.",
            reply_markup=back_to_admin_markup
        )
        await state.update_data(admin_message_id=callback.message.message_id)
        await state.set_state(AdminStates.waiting_for_channel_mailing_message)
    elif action == "repeat_last_channel_mail":
        content, keyboard = await get_last_mail_content("channel")
        if not content:
            await callback.answer("‚ö†Ô∏è So≈àky habar tapylmady.", show_alert=True)
            return

        await state.update_data(mailing_content=content, mailing_keyboard=keyboard)
        await callback.message.delete()
        
        preview_text = "üóÇÔ∏è <b>So≈àky habary tassykla≈à:</b>\n\n≈ûu habary kanallara iber√Ω√§rismi?"
        preview_msg = await send_mail_preview(callback.from_user.id, content, keyboard)
        
        confirmation_keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text="‚úÖ Hawa, ibermek", callback_data="channel_mail_confirm_send_repeated")],
            [InlineKeyboardButton(text="‚¨ÖÔ∏è √ùok, yza", callback_data="admin_panel_main")]
        ])
        confirm_msg = await bot.send_message(callback.from_user.id, preview_text, reply_markup=confirmation_keyboard)

        await state.update_data(admin_message_id=confirm_msg.message_id, preview_message_id=preview_msg.message_id)
        await state.set_state(AdminStates.waiting_for_channel_mailing_confirmation)
    await callback.answer()


@router.callback_query(AdminStates.waiting_for_channel_mailing_confirmation)
async def process_channel_mailing_confirmation(callback: types.CallbackQuery, state: FSMContext):
    fsm_data = await state.get_data()
    mailing_content = fsm_data.get('mailing_content')
    mailing_keyboard = fsm_data.get('mailing_keyboard')
    
    try:
        await bot.delete_message(callback.from_user.id, fsm_data.get('admin_message_id'))
        await bot.delete_message(callback.from_user.id, fsm_data.get('preview_message_id'))
    except (TelegramBadRequest, KeyError): pass

    if not mailing_content:
        await bot.send_message(callback.from_user.id, "‚ö†Ô∏è √ùal≈ày≈ülyk: habar tapylmady.", reply_markup=back_to_admin_markup)
        await state.clear()
        return

    if callback.data in ["channel_mail_confirm_send", "channel_mail_confirm_send_repeated"]:
        msg_for_broadcast = await bot.send_message(callback.from_user.id, "‚è≥...")
        await execute_channel_broadcast(msg_for_broadcast, mailing_content, mailing_keyboard)
        await state.clear()
    elif callback.data == "channel_mail_confirm_add_buttons":
        msg = await bot.send_message(
            callback.from_user.id,
            "üîó <b>D√ºwmeleri go≈ümak</b> üîó\n\nFormat: <code>Tekst - https://salgy.com</code>\nHer d√ºwme t√§ze setirde.",
            reply_markup=back_to_admin_markup
        )
        await state.update_data(admin_message_id=msg.message_id)
        await state.set_state(AdminStates.waiting_for_channel_mailing_buttons)
    await callback.answer()


@router.message(AdminStates.waiting_for_channel_mailing_buttons)
async def process_channel_mailing_buttons(message: Message, state: FSMContext):
    keyboard = parse_buttons_from_text(message.text)
    if not keyboard:
        await message.answer("‚ö†Ô∏è N√§dogry format! T√§zeden synany≈üy≈à.")
        return
    
    await message.delete()
    fsm_data = await state.get_data()
    mailing_content = fsm_data.get('mailing_content')

    try: await bot.delete_message(message.chat.id, fsm_data.get('admin_message_id'))
    except (TelegramBadRequest, KeyError): pass
    
    msg_for_broadcast = await bot.send_message(message.chat.id, "‚è≥...")
    await execute_channel_broadcast(msg_for_broadcast, mailing_content, keyboard)
    await state.clear()
# ...
# Buradan itibaren geri kalan t√ºm orijinal fonksiyonlar (addlist, vpn, welcome, admin ekleme/silme, subscription check vb.)
# olduƒüu gibi kalabilir ve √ßalƒ±≈ümaya devam edecektir.
# ...

@router.callback_query(lambda c: c.data == "check_subscription")
async def process_check_subscription(callback: types.CallbackQuery, state: FSMContext):
    user_id = callback.from_user.id
    vpn_configs_full = await get_vpn_configs_from_db()
    vpn_configs_texts = [item['config_text'] for item in vpn_configs_full]

    if not vpn_configs_texts:
        try:
            await callback.message.edit_text("üòî Gynansak-da, h√§zirki wagtda el√Ωeterli VPN kody √Ωok. Ha√Ωy≈ü ed√Ω√§ris, so≈àrak synany≈üy≈à.")
        except TelegramBadRequest:
            await callback.answer(text="üòî El√Ωeterli VPN kody √Ωok. So≈àrak synany≈üy≈à.", show_alert=True)
        await state.clear()
        return

    user_still_needs_to_subscribe = await has_unsubscribed_channels(user_id)
    channels_configured = bool(await get_channels_from_db())

    if not user_still_needs_to_subscribe:
        vpn_config_text = random.choice(vpn_configs_texts)
        text = "üéâ Siz √§hli kanallara agza boldu≈àyz." if channels_configured else "‚ú® Agza bolany≈àyz √º√ßin sagbolu≈à"
        try:
            await callback.message.edit_text(
                f"{text}\n\n"
                f"üîë <b>Sizi≈à VPN kodu≈àyz:</b>\n<pre><code>{vpn_config_text}</code></pre>",
                reply_markup=None
            )
            await callback.answer(text="‚úÖ Agzalyk barlandy!", show_alert=False)
        except TelegramBadRequest:
             await callback.answer(text="‚úÖ Agzalyk barlandy!", show_alert=False)
        await state.clear()
    else:
        new_keyboard = await create_subscription_task_keyboard(user_id)
        welcome_text_db = await get_setting_from_db('welcome_message', "üëã VPN kodyny almak √º√ßin, a≈üakdaky kanallara agza bolu≈à:")

        message_needs_update = False
        if callback.message:
            if (callback.message.html_text != welcome_text_db) or \
               (new_keyboard != callback.message.reply_markup):
                 message_needs_update = True

            if message_needs_update:
                try:
                    await callback.message.edit_text(welcome_text_db, reply_markup=new_keyboard)
                except TelegramBadRequest as e:
                    if "message is not modified" in str(e).lower():
                        pass
                    else:
                        logging.error(f"agzalygy barlanda habary redaktirlemekde √Ωal≈ày≈ülyk: {e}")
        await callback.answer(
            text="‚ö†Ô∏è Ha√Ωy≈ü ed√Ω√§ris, √§hli g√∂rkezilen kanallara agza bolu≈à we t√§zeden synan≈üy≈à",
            show_alert=True
        )

# Diƒüer t√ºm yardƒ±mcƒ± fonksiyonlar (addlist, vpn, welcome, admin y√∂netimi vs.)
# Deƒüi≈ütirilmeden kalabilir.
# ... (add_addlist_prompt, save_addlist_name, delete_addlist_prompt...)
# ... (add_vpn_config_prompt, save_vpn_config, delete_vpn_config_prompt...)
# ... (change_welcome_prompt, save_welcome_message...)
# ... (add_admin_prompt, process_add_admin_id, delete_admin_prompt...)


async def main():
    global DB_POOL
    try:
        DB_POOL = await asyncpg.create_pool(dsn=DATABASE_URL)
        if DB_POOL:
            logging.info("Successfully connected to PostgreSQL and connection pool created.")
            await init_db(DB_POOL)
            logging.info("Database initialized (tables created if they didn't exist).")
        else:
            logging.error("Failed to create database connection pool.")
            return
    except Exception as e:
        logging.critical(f"Failed to connect to PostgreSQL or initialize database: {e}")
        return

    await dp.start_polling(bot)

    if DB_POOL:
        await DB_POOL.close()
        logging.info("PostgreSQL connection pool closed.")

if __name__ == '__main__':
    asyncio.run(main())
